"use strict";(self.webpackChunkfocalboard=self.webpackChunkfocalboard||[]).push([[626],{4836:(e,t,n)=>{n.d(t,{Z:()=>s});var o=n(8081),r=n.n(o),a=n(23645),i=n.n(a)()(r());i.push([e.id,".focalboard-body .EntryComponent{display:flex;align-items:center;justify-content:space-between;width:100%}.focalboard-body .EntryComponent .EntryComponent__left{display:flex;align-items:center}.focalboard-body .EntryComponent .EntryComponent__hint{opacity:.56}",""]);const s=i},34388:(e,t,n)=>{n.d(t,{Z:()=>s});var o=n(8081),r=n.n(o),a=n(23645),i=n.n(a)()(r());i.push([e.id,".focalboard-body .MarkdownEditorInput div[role=option]{display:flex;align-items:center}.focalboard-body .MarkdownEditorInput span[data-testid=mentionText]{background:rgba(var(--button-bg-rgb), 0.16);border-radius:4px;color:inherit}.focalboard-body .DraftEditor-root+div{background:rgba(var(--center-channel-bg-rgb), 1);box-shadow:var(--elevation-1);border:1px solid rgba(var(--center-channel-color-rgb), 0.16);border-radius:4px}.focalboard-body .DraftEditor-root+div>div>div{height:40px;padding:0 20px}.focalboard-body .DraftEditor-root+div>div>div[aria-selected=true]{background:rgba(var(--center-channel-color-rgb), 0.08)}.focalboard-body .DraftEditor-root+div>div>div:hover{background:rgba(var(--center-channel-color-rgb), 0.08)}.focalboard-body .DraftEditor-root+div>div>div:active{background:rgba(var(--button-bg-rgb), 0.08)}.focalboard-body .DraftEditor-root+div>div>div .Badge{margin-left:12px}.focalboard-body .DraftEditor-root+div .code-block{background-color:unset;border:0}",""]);const s=i},11499:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ie});var o=n(37166),r=n(83550),a=(n(79233),n(59616)),i=(n(68276),n(99435)),s=n(71005),l=n.n(s),c=n(96486),d=n(95164),g=n(54214),u=n(43393);const m=(e,t)=>{const n=[];let o;do{o=t.exec(e),o&&n.push([o.index,o.index+o[0].length-1])}while(o);return n},y=()=>{const e=new RegExp("(\\*\\*\\*)(.+?)(\\*\\*\\*)|(\\*\\*)(.+?)(\\*\\*)(?!\\*)|(___)(.+?)(___)|(__)(.+?)(__)(?!_)","g"),t=/^(\*\*\*|\*\*|___|__)|(\*\*\*|\*\*|___|__)$/g;return{style:"BOLD",delimiterStyle:"BOLD-DELIMITER",findStyleRanges:t=>{const n=t.getText();return m(n,e)},findDelimiterRanges:(e,n)=>{const o=e.getText();let r=[];return n.forEach((e=>{const n=m(o.substring(e[0],e[1]+1),t).map((t=>t.map((t=>t+e[0]))));r=r.concat(n)})),r},delimiterStyles:{opacity:.4}}},p=()=>{const e="(\\*\\*\\*|___)(.+?)(\\*\\*\\*|___)";let t;try{t=new RegExp(`(?<!\\*)(\\*)(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)|(?<!_)(_)(?!_)(.+?)(?<!_)_(?!_)|${e}|(?<=\\*\\*)(\\*)(?!\\*)(.*?[^\\*]+)(?<!\\*)\\*(?![^\\*]\\*)|(?<!\\*)(\\*)(?!\\*)(.*?[^\\*]+)(?<!\\*)\\*(?=\\*\\*)|(?<=__)(_)(?!_)(.*?[^_]+)(?<!_)_(?![^_]_)|(?<!_)(_)(?!_)(.*?[^_]+)(?<!_)_(?=__)`,"g")}catch{t=new RegExp(`([^\\*]|^)(\\*)([^\\*]+)(\\*)(?!\\*)|([^_]|^)(_)([^_]+)(_)(?!_)|${e}`,"g")}const n=/^(\*\*\*|\*|___|_)|(\*\*\*|\*|___|_)$/g;return{style:"ITALIC",delimiterStyle:"ITALIC-DELIMITER",findStyleRanges:e=>{const n=e.getText();return m(n,t)},findDelimiterRanges:(e,t)=>{const o=e.getText();let r=[];return t.forEach((e=>{const t=m(o.substring(e[0],e[1]+1),n).map((t=>t.map((t=>t+e[0]))));r=r.concat(t)})),r},delimiterStyles:{opacity:.4}}},E=()=>{const e=/(~~)(.+?)(~~)/g,t=/^(~~)|(~~)$/g;return{style:"STRIKETHROUGH",delimiterStyle:"STRIKETHROUGH-DELIMITER",findStyleRanges:t=>{const n=t.getText();return m(n,e)},findDelimiterRanges:(e,n)=>{const o=e.getText();let r=[];return n.forEach((e=>{const n=m(o.substring(e[0],e[1]+1),t).map((t=>t.map((t=>t+e[0]))));r=r.concat(n)})),r},styles:{textDecoration:"line-through"},delimiterStyles:{opacity:.4,textDecoration:"none"}}},b=()=>{const e=/(^#{1,6})\s/g;return{style:"HEADING-DELIMITER",findStyleRanges:t=>{if(t.getType().indexOf("header")<0)return[];const n=t.getText();return m(n,e)},styles:{opacity:.4}}},f=()=>{const e=/^\* /g;return{style:"UL-DELIMITER",findStyleRanges:t=>{const n=t.getText();return m(n,e)},styles:{fontWeight:"bold"}}},h=()=>{const e=/^\d{1,3}\. /g;return{style:"OL-DELIMITER",findStyleRanges:t=>{const n=t.getText();return m(n,e)},styles:{fontWeight:"bold"}}},S=()=>{const e=/^> (.*)/g,t=/^> /g;return{style:"QUOTE",delimiterStyle:"QUOTE-DELIMITER",findStyleRanges:t=>{const n=t.getText();return m(n,e)},findDelimiterRanges:(e,n)=>{const o=e.getText();let r=[];return n.forEach((e=>{const n=m(o.substring(e[0],e[1]+1),t).map((t=>t.map((t=>t+e[0]))));r=r.concat(n)})),r},styles:{opacity:.75},delimiterStyles:{opacity:.4}}},_=()=>{const e=/(`)([^\n\r`]+?)(`)/g;return{style:"INLINE-CODE",findStyleRanges:t=>{if("code-block"===t.getType())return[];const n=t.getText();return m(n,e)},styles:{fontFamily:"monospace"}}},T=()=>{const e="code-block",t=/^```/g;return{type:e,className:"code-block",mapBlockType:n=>{const o=n.getBlockMap();let r,a=n,s=[],l=[],c=[];return o.forEach(((e,n)=>{if(!e||!n)return;const o=e.getText(),a=m(o,t),i=c.length>0;a.length>0&&!i&&(r=(o.match(/\w+/g)||[])[0]||"javascript"),a.length>0||i?c.push(n):l.push(n),a.length>0&&i&&(s=s.concat(c),c=[])})),l=l.concat(c),l.forEach((t=>{a.getBlockForKey(t).getType()===e&&(a=i.Modifier.setBlockType(a,i.SelectionState.createEmpty(t),"unstyled"))})),s.forEach(((t,n)=>{const o=0===n||n===s.length-1,l=a.getBlockForKey(t),c=a.getBlockMap(),d=l.getData().merge({language:o?void 0:r}),g=l.merge({data:d});a=a.merge({blockMap:c.set(t,g)}),a=i.Modifier.setBlockType(a,i.SelectionState.createEmpty(t),e)})),a}}},C=()=>{const e=/(^#{1,6})\s(.*)/gm,t=["header-one","header-two","header-three","header-four","header-five","header-six"];return{type:"heading",className:"heading-block",mapBlockType:n=>{const o=n.getBlockMap();let r=n;return o.forEach(((n,o)=>{if(!n||!o)return;const a=n.getText(),s=m(a,e);let l=1;s.length>0&&(l=(a.match(/#/g)||[]).length),s.length>0?r=i.Modifier.setBlockType(r,i.SelectionState.createEmpty(o),t[l-1]):t.includes(r.getBlockForKey(o).getType())&&(r=i.Modifier.setBlockType(r,i.SelectionState.createEmpty(o),"unstyled"))})),r}}},k=(e,t)=>t.reduce(((e,t)=>t.mapBlockType(e)),e),v=(e,t,n)=>{const o=t.getLastChangeType(),r=t.getSelection().getStartKey(),a=e.getBlockForKey(r),i=e.getBlockMap();let s=i;if("insert-fragment"!==o&&o){const e=B(a,n);s=s.set(r,e)}else i.forEach(((e,t)=>{if(!e||!t)return;const o=B(e,n);s=s.set(t,o)}));if("split-block"===o){const t=B(e.getBlockBefore(r),n);s=s.set(e.getKeyBefore(r),t)}return e.merge({blockMap:s})},B=(e,t)=>{const n=e.getText();let o=(0,u.List)((0,u.Repeat)(i.CharacterMetadata.create(),n.length));return t.forEach((t=>{const n=t.findStyleRanges(e),r=t.findDelimiterRanges?t.findDelimiterRanges(e,n):[];o=x(t.style,n,o),o=x(t.delimiterStyle,r,o)})),e.set("characterList",o)},x=(e,t,n)=>{let o=n;return e?(t.forEach((t=>{for(let r=t[0];r<=t[1];r++){const t=i.CharacterMetadata.applyStyle(n.get(r),e);o=o.set(r,t)}})),o):o},M=function(e={}){const{inlineStyleStrategies:t=[y(),p(),E(),b(),f(),h(),S(),_()],blockTypeStrategies:n=[T(),C()]}=e,o={};t.forEach((e=>{e.style&&e.styles&&(o[e.style]=e.styles),e.delimiterStyle&&e.delimiterStyles&&(o[e.delimiterStyle]=e.delimiterStyles)}));const r=n.reduce(((e,t)=>(e[t.type]=t.className,e)),{});return{onChange:e=>((e,t,n)=>{const o=e.getLastChangeType();if(["adjust-depth","apply-entity","change-block-data","change-block-type","change-inline-style","maintain-markdown"].includes(o))return e;const r=e.getCurrentContent();let a=k(r,t);a=v(a,e,n);let s=e;return r!==a&&(s=i.EditorState.push(e,a,"maintain-markdown")),s=i.EditorState.forceSelection(s,e.getSelection()),s})(e,n,t),customStyleMap:o,blockStyleFn:e=>{const t=e.getType();return r[t]}}};var R=n(78242),D=n(7915),I=n(29432),w=n(52724),U=n(56662),L=n(37230),N=n(93379),Z=n.n(N),K=n(7795),A=n.n(K),F=n(90569),O=n.n(F),P=n(3565),$=n.n(P),j=n(19216),H=n.n(j),Q=n(44589),G=n.n(Q),V=n(34388),W={};W.styleTagTransform=G(),W.setAttributes=$(),W.insert=O().bind(null,"head"),W.domAPI=A(),W.insertStyleElement=H(),Z()(V.Z,W),V.Z&&V.Z.locals&&V.Z.locals;var z=n(78146),q=n(39302),J=n(77867),X=n(37721),Y=n(76735),ee=n(58784),te=n(4836),ne={};ne.styleTagTransform=G(),ne.setAttributes=$(),ne.insert=O().bind(null,"head"),ne.domAPI=A(),ne.insertStyleElement=H(),Z()(te.Z,ne),te.Z&&te.Z.locals&&te.Z.locals;const oe=window.Components?.BotBadge,re=e=>{const{mention:t,theme:n,...o}=e;return l().createElement("div",{...o},l().createElement("div",{className:`${n?.mentionSuggestionsEntryContainer} EntryComponent`},l().createElement("div",{className:"EntryComponent__left"},l().createElement("img",{src:t.avatar,className:n?.mentionSuggestionsEntryAvatar,role:"presentation"}),l().createElement("div",{className:n?.mentionSuggestionsEntryText},t.name,oe&&t.is_bot&&l().createElement(oe,null),l().createElement(ee.Z,{show:t.is_guest})),l().createElement("div",{className:n?.mentionSuggestionsEntryText},t.displayName)),!t.isBoardMember&&l().createElement("div",{className:`EntryComponent__hint ${n?.mentionSuggestionsEntryText}`},l().createElement(Y.FormattedMessage,{id:"MentionSuggestion.is-not-board-member",defaultMessage:"(not board member)"}))))},ae=window.Components?.imageURLForUser,ie=e=>{const{onChange:t,onFocus:n,onBlur:u,initialText:m,id:y}=e,p=(0,d.C)(g.KL),E=(0,d.C)(z.tQ),b=(0,d.C)(X.Zb),f=(0,s.useRef)(null),h=(0,R.zE)(E.teamId,E.id,[D.y.ManageBoardRoles]),[S,_]=(0,s.useState)(null),T=(0,d.C)(g.jo),[C,k]=(0,s.useState)([]),v=async e=>{let t;if(!T?.is_guest&&(h||E&&E.type===I.ab)){const n=!0;t=await q.Z.searchTeamUsers(e,n)}else t=p.filter((t=>!e||J.cQ.getUserDisplayName(t,b.teammateNameDisplay).includes(e))).slice(0,10);const n=t.map((e=>({name:e.username,avatar:`${ae?ae(e.id):""}`,is_bot:e.is_bot,is_guest:e.is_guest,displayName:J.cQ.getUserDisplayName(e,b.teammateNameDisplay),isBoardMember:Boolean(p.find((t=>t.id===e.id))),user:e})));k(n)},B=(0,s.useMemo)((()=>(0,c.debounce)(v,200)),[]);(0,s.useEffect)((()=>{v("")}),[]);const x=e=>{const t=i.EditorState.createWithContent(i.ContentState.createFromText(e||""));return i.EditorState.moveSelectionToEnd(t)},[N,Z]=(0,s.useState)((()=>x(m))),K=(0,s.useCallback)((async(e,t)=>{const n=t||I.UB.Viewer,o={boardId:E.id,userId:e,roles:t,schemeAdmin:n===I.UB.Admin,schemeEditor:n===I.UB.Admin||n===I.UB.Editor,schemeCommenter:n===I.UB.Admin||n===I.UB.Editor||n===I.UB.Commenter,schemeViewer:n===I.UB.Admin||n===I.UB.Editor||n===I.UB.Commenter||n===I.UB.Viewer};_(null),Z(i.EditorState.moveSelectionToEnd(N)),f.current?.focus(),await w.Z.createBoardMember(o)}),[E,N]),[A,F]=(0,s.useState)(m),[O,P]=(0,s.useState)(!1);(0,s.useEffect)((()=>{!O&&m&&m!==A&&(Z(x(m||"")),F(m),P(!0))}),[m]);const[$,j]=(0,s.useState)(!1),[H,Q]=(0,s.useState)(!1),{MentionSuggestions:G,plugins:V,EmojiSuggestions:W}=(0,s.useMemo)((()=>{const e=(0,a.ZP)({mentionPrefix:"@"}),t=(0,r.Z)(),n=M(),{EmojiSuggestions:o}=t,{MentionSuggestions:i}=e;return{plugins:[e,t,n],MentionSuggestions:i,EmojiSuggestions:o}}),[]),Y=(0,s.useCallback)((e=>{const n=e.getCurrentContent().getPlainText();t&&t(n),Z(e)}),[t]),ee=(0,s.useCallback)((e=>{if(!$&&!H)return"Escape"===e.key?"editor-blur":"Backspace"===e.key?"backspace":"undo"===(0,i.getDefaultKeyBinding)(e)?"editor-undo":"redo"===(0,i.getDefaultKeyBinding)(e)?"editor-redo":(0,i.getDefaultKeyBinding)(e)}),[H,$]),te=(0,s.useCallback)(((t,n)=>{if("editor-blur"===t)return f.current?.blur(),"handled";if("editor-redo"===t){const e=i.EditorState.redo(n);return Y(i.EditorState.redo(e)),"handled"}if("editor-undo"===t){const e=i.EditorState.undo(n);return Y(i.EditorState.undo(e)),"handled"}return"backspace"===t&&e.onEditorCancel&&0===N.getCurrentContent().getPlainText().length?(e.onEditorCancel(),"handled"):"not-handled"}),[e.onEditorCancel,N]),ne=(0,s.useCallback)((()=>{if(S)return;const e=N.getCurrentContent().getPlainText();u&&u(e)}),[N.getCurrentContent().getPlainText(),u,S]),oe=(0,s.useCallback)((e=>{j(e)}),[]),ie=(0,s.useCallback)((()=>{Q(!0)}),[]),se=(0,s.useCallback)((()=>{Q(!1)}),[]),le=(0,s.useCallback)((({value:e})=>{B(e)}),[C]);return l().createElement("div",{className:"MarkdownEditorInput",onKeyDown:e=>{($||H)&&e.stopPropagation()}},l().createElement(o.ZP,{editorKey:y,editorState:N,onChange:Y,plugins:V,ref:f,onBlur:ne,onFocus:n,keyBindingFn:ee,handleKeyCommand:te,handleReturn:e.saveOnEnter?(e,t)=>{if(!e.shiftKey){const e=t.getCurrentContent().getPlainText();return u&&u(e),"handled"}return"not-handled"}:void 0}),l().createElement(G,{open:$,onOpenChange:oe,suggestions:C,onSearchChange:le,entryComponent:re,onAddMention:e=>{e.isBoardMember||_(e.user)}}),l().createElement(W,{onOpen:ie,onClose:se}),S&&l().createElement(L.Z,null,l().createElement(U.Z,{allowManageBoardRoles:h,minimumRole:E.minimumRole,user:S,onConfirm:K,onClose:()=>{_(null),Z(i.EditorState.moveSelectionToEnd(N)),f.current?.focus()}})))}}}]);